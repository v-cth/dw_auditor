# ============================================================================
# Data Warehouse Audit Configuration
# ============================================================================
# This YAML file configures the table auditor behavior, including database
# connections, sampling, security settings, and output formats.

# Database Connection
# ----------------------------------------------------------------------------
database:
  backend: "snowflake"  # Options: bigquery, snowflake
  connection_params:
    # Required: default_database and default_schema for all backends
    default_database: "SF_TRIAL" #"portfolio-402"  # BigQuery: project_id | Snowflake: database name
    default_schema: "PUBLIC" #"demo"        # BigQuery: dataset | Snowflake: schema name

    # Optional for BigQuery:
    # credentials_path: "/path/to/service-account-key.json"
    # If not specified, uses Application Default Credentials (gcloud auth)

    # Required for Snowflake (if using Snowflake):
    account: "OOQYWEC-ND51384"
    user: "VALENTIN"
    password: "ProfilerSF7$"
    # warehouse: "my-warehouse"  # Optional
    # role: "my-role"            # Optional

# Tables to Audit
# ----------------------------------------------------------------------------
# Can be a simple list of table names OR objects with custom queries
tables:
  # Simple table names
  - name: customers
    primary_key: customer_id
  - orders
  - name: order_items
    query: "select * from order_items where product_id > 104"

  - products
  - demo_users
  # - name: fct_avaibility_part
  #   schema: dbt_prod
  #   query: "select * from fct_avaibility_part where collected_at > '2025-10-01'"
  # - name: dim_station_v
  #   schema: dbt_prod
  # - name: dim_station
  #   schema: dbt_prod

  # # Cross-project table example (BigQuery)
  # - name: crime
  #   database: bigquery-public-data
  #   schema: chicago_crime
  #   exclude_columns: ["description", "domestic"]


  # Table with custom query (for filtering or joining)
  # - name: recent_transactions
  #   query: "SELECT * FROM transactions WHERE created_at > NOW() - INTERVAL '30 days'"

  # Table with per-table column filtering (overrides global filters)
  # - name: large_table
  #   exclude_columns: ["description", "metadata", "raw_data"]  # Exclude heavy columns


# Sampling Configuration
# ----------------------------------------------------------------------------
# Sampling always uses database-native operations via Ibis (fast & secure)
sampling:
  # Number of rows to sample from large tables
  sample_size: 500000

# Security Settings
# ----------------------------------------------------------------------------
security:
  # Automatically mask columns containing PII
  mask_pii: false
  
  # Additional keywords to identify PII columns (beyond defaults)
  # Default keywords: ssn, email, phone, address, credit_card, password, etc.
  custom_pii_keywords:
    - "employee_id"
    - "customer_number"
    - "internal_code"
    - "confidential"

# Column-Level Quality Checks Configuration
# ----------------------------------------------------------------------------
# Define data quality checks per data type
column_checks:
  defaults:
    string:
      trailing_characters: true     # Detect trailing whitespace
      case_duplicates: true          # Find duplicates ignoring case
    datetime:
      greater_than: '2025-10-01'
      future_dates: true             # Detect dates in the future
      date_outliers:                 # Detect suspicious placeholder years
        problematic_years: [1900, 1970, 2099, 2999, 9999]
    numeric:
      greater_than_or_equal: 0       # Ensure non-negative values

  # Per-table/column overrides (optional)
  tables:
    orders:
      order_id:
        uniqueness: true             # Ensure order IDs are unique
      order_date:
        after: "2026-01-01"          # Business rule: orders after 2020
    customers:
      email:
        regex_pattern:               # Validate email format
          pattern: "^[\\w._%+-]+@[\\w.-]+\\.[a-zA-Z]{2,}$"
          mode: "match"
          description: "Valid email format"

# Column-Level Insights Configuration
# ----------------------------------------------------------------------------
# Define statistical insights per data type
column_insights:
  defaults:
    string:
      top_values: 10                 # Show top 10 most frequent values
      min_length: true
      max_length: true
      avg_length: true
    numeric:
      min: true
      max: true
      mean: true
      std: true                      # Standard deviation
      quantiles: true                # Default quantiles: 25th, 50th, 75th percentiles
      top_values: 5                  # Show top 5 most common numeric values
      histogram:
        bins: 15
        method: "quartiles"  # equal_width, equal_frequency, quartiles, explicit
        edge_handling: "include_left"

    datetime:
      min_date: true
      max_date: true
      date_range_days: true
      most_common_days: 7            # Most common days of week
      most_common_hours: 10          # Most common hours of day
    boolean:
      top_values: 2                  # True/False distribution

  # Per-table/column overrides (optional)
  # tables:
  #   orders:
  #     total_price:
  #       quantiles: true  # Note: composite insights only accept boolean, not custom quantile lists

# Relationship Detection Configuration
# ----------------------------------------------------------------------------
# Automatically discover foreign key relationships between tables
relationship_detection:
  enabled: true                     # Enable automatic relationship detection
  confidence_threshold: 0.7          # Minimum confidence (0.0-1.0) to report a relationship
  min_confidence_display: 0.5        # Minimum confidence to display in reports
  exclude_tables: ["dim_station_v"]                 # Tables to exclude from relationship detection (e.g., ["staging_temp", "logs"])

  # How it works:
  # - Analyzes column names, data types, and value distributions
  # - Detects potential foreign key relationships (e.g., orders.customer_id â†’ customers.id)
  # - Generates confidence scores based on:
  #   - Name similarity (e.g., "customer_id" matches "id" in customers table)
  #   - Data type compatibility
  #   - Value overlap (% of foreign key values that exist in primary key)
  #   - Uniqueness constraints
  # - Creates visual ER diagrams in HTML reports

  # Example: Enable for multi-table audits to discover schema relationships
  # enabled: true
  # confidence_threshold: 0.7   # Report relationships with >= 70% confidence
  # min_confidence_display: 0.5 # Show all relationships >= 50% in reports

# Output Configuration
# ----------------------------------------------------------------------------
output:
  # Directory where audit results will be saved
  directory: "audit_results"
  
  # Export formats: html, json, csv, parquet
  formats:
    - html      # Beautiful interactive report
    - csv       # For Excel/analysis
    - json      # For APIs/automation

  auto_open_html: false # Opens HTML reports in browser when audit ends
  
  
  # Prefix for output filenames
  # Final format: {prefix}_{table_name}_{timestamp}.{extension}
  file_prefix: "audit"

# Column Filters (Optional)
# ----------------------------------------------------------------------------
# Use these to limit which columns are audited
filters:
  # If specified, ONLY audit these columns (leave empty to audit all)
  include_columns: []
    # - "customer_name"
  
  # If specified, SKIP these columns
  exclude_columns: []
    # - "internal_metadata"

